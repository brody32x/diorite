version: 2
jobs:
  build:
    docker:
      - image: fedora:29
    working_directory: ~/workdir
    steps:
      - run:
          name: Install deps
          command: |
            dnf update -y > /dev/null
            dnf install -y git openssh-clients \
              gcc vala vala-devel valadoc gobject-introspection-devel 'pkgconfig(python3)' \
              'pkgconfig(gtk+-3.0)' sqlite-devel python3-pyparsing \
              wget tar xz \
              make autoconf automake glib2-devel graphviz-devel flex bison libxslt
            dnf clean all > /dev/null
      - run:
          name: Install Valalint
          command: |
            git clone https://github.com/tiliado/valalint.git
            cd valalint
            make all
            make install
            cd ..
            rm -rf valalint
      - checkout:
          path: ~/workdir/diorite
      - run:
          name: Build and run tests
          working_directory: ~/workdir/diorite
          command: |
            ./waf configure build install
            /sbin/ldconfig
            LD_LIBRARY_PATH=./build ./build/run-dioritetests
            make valalint
